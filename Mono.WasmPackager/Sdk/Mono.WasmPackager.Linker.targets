<Project>
  <PropertyGroup>
    <LinkBlazorApplicationDependsOn>
      $(LinkBlazorApplicationDependsOn);
      WasmPackager;
    </LinkBlazorApplicationDependsOn>
    <LinkerOptimizerDependsOn>
      $(LinkerOptimizerDependsOn);
    </LinkerOptimizerDependsOn>
    <LinkerOptimizerConfigurationDependsOn>
      $(LinkerOptimizerConfigurationDependsOn);
      _WasmPackager_PrepareOptimizerConfiguration;
    </LinkerOptimizerConfigurationDependsOn>
    <_WasmPackager_Require_Link>
      $(_WasmPackager_Require_Link);
      _LinkerOptimizer_LinkApplication;
    </_WasmPackager_Require_Link>
  </PropertyGroup>

  <Target Name="_WasmPackager_PrepareOptimizerConfiguration" DependsOnTargets="$(_WasmPackager_Require_PreLink)">
    <Message Importance="High" Text="WasmPackager: $(WasmPackager_BuildDir)" />

    <PropertyGroup>
      <LinkerOptimizerInputPath>$(_WasmPackager_LinkerInput_Dir)</LinkerOptimizerInputPath>
      <LinkerOptimizerOutputPath>$(_WasmPackager_LinkerOutput_Dir)</LinkerOptimizerOutputPath>
      <LinkerOptimizerEnabled Condition="'$(LinkerOptimizerEnabled)' == ''">true</LinkerOptimizerEnabled>
      <LinkerOptimizerExtraLinkerArguments>--verbose -c link -u copy --deterministic --disable-opt unreachablebodies --exclude-feature com --exclude-feature remoting --exclude-feature etw</LinkerOptimizerExtraLinkerArguments>
    </PropertyGroup>

    <PropertyGroup Condition="'$(WasmPackager_AddBinding)' == 'true'">
      <LinkerOptimizerExtraLinkerArguments>$(LinkerOptimizerExtraLinkerArguments) -p link %(WasmPackager_BindingsModules.Identity) -r %(WasmPackager_BindingsModules.Identity)</LinkerOptimizerExtraLinkerArguments>
    </PropertyGroup>

    <GetFirstItem Input="@(_WasmPackager_Assemblies)">
      <Output TaskParameter="Output" ItemName="__WasmPackager_FirstInput" />
    </GetFirstItem>

    <ItemGroup>
      <LinkerOptimizerInputAssembly Include="%(__WasmPackager_FirstInput.LinkerInput)" />
      <LinkerOptimizerDependencyInput Include="%(_WasmPackager_Assemblies.LinkerInput)" Condition="'%(_WasmPackager_Assemblies.SkipLink)' != 'true'" />
      <LinkerOptimizerDependencyInput Remove="%(__WasmPackager_FirstInput.LinkerInput)" />
      <LinkerOptimizerBaseClassLibraryPath Include="$(WasmPackager_MonoBclPath);$(WasmPackager_MonoBclPath)/Facades" />
      <LinkerOptimizerBaseClassLibraryPath Include="$(MonoWebAssemblyFrameworkRoot);$(MonoWebAssemblyBindingsRoot);@(WasmPackager_FrameworkDirectories)" />
    </ItemGroup>

    <Message Importance="High" Text="WasmPackager - prepare optimizer config" />
    <Message Text="  input assembly: %(LinkerOptimizerInputAssembly.Identity)" />
    <Message Text="  dependency:     %(LinkerOptimizerDependencyInput.Identity)" />
    <Message Text="  arguments:      $(LinkerOptimizerExtraLinkerArguments)" />

  </Target>

</Project>
